# CareTopicz Agent Service CI
# Lint (ruff) -> test (pytest) -> eval (80% gate) -> build
name: Agent CI

on:
  push:
    branches: [master, main]
    paths: ["agent-service/**"]
  pull_request:
    branches: [master, main]
    paths: ["agent-service/**"]

defaults:
  run:
    working-directory: agent-service

jobs:
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff
        run: ruff check app evals tests

  test:
    name: Test (pytest)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pytest
        run: pytest tests/ -v --tb=short
        env:
          # Skip e2e tests that require ANTHROPIC_API_KEY
          ANTHROPIC_API_KEY: ""

  # Eval requires ANTHROPIC_API_KEY repo secret. Blocks merge if pass rate < 80%.
  eval:
    name: Eval (80% gate)
    runs-on: ubuntu-24.04
    needs: [lint, test]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Start agent
        run: |
          uvicorn app.main:app --host 127.0.0.1 --port 8000 &
          for i in $(seq 1 30); do
            curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/health | grep -q 200 && break
            sleep 1
          done
          curl -s http://127.0.0.1:8000/health || exit 1

      - name: Run evals (80% pass rate gate)
        run: python evals/runner.py --all --min-pass-rate 0.8 --url http://127.0.0.1:8000
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  build:
    name: Build (Docker)
    runs-on: ubuntu-24.04
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build agent image
        uses: docker/build-push-action@v6
        with:
          context: ./agent-service
          file: ./agent-service/Dockerfile
          push: false
          load: true
          tags: caretopicz-agent:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
